# Каждый час сам обновляет версию и дату OSP2, пишет в assets/osp2-version.json.
# Страница читает этот файл — к API с браузера не ходим, дата всегда есть.
# Никаких секретов: используется встроенный GITHUB_TOKEN.
name: Update OSP2 version

on:
  schedule:
    - cron: '0 * * * *'   # каждый час
  workflow_dispatch:      # или вручную: Actions → Update OSP2 version → Run workflow

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch version and date
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/snems/OSP2/contents/code/cgame/cg_local.h?ref=master" \
            | jq -r '.content // empty' | base64 -d | grep -oP '#define\s+OSP_VERSION\s+"\K[^"]+' || true)
          RELEASE=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/snems/OSP2/releases/latest")
          DATE_ISO=$(echo "$RELEASE" | jq -r '.published_at // empty')
          [ -n "$DATE_ISO" ] && DATE=$(date -d "$DATE_ISO" +"%d.%m.%Y") || DATE=""
          jq -n --arg v "$VERSION" --arg d "$DATE" '{version:$v, date:$d}' -c > assets/osp2-version.json
          echo "version=$VERSION date=$DATE"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/osp2-version.json
          git diff --staged --quiet || (git commit -m "chore: update OSP2 version" && git push)
