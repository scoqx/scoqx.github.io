# Загрузка карт из PK3/ZIP архивов

## Быстрый старт

### 1. Подключите JSZip библиотеку

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
```

### 2. Загрузите PK3 файл с картами

```javascript
// Предположим у вас есть syscallHandler
const syscallHandler = new Q3VMSyscallHandler(canvas, ctx);

// Загрузка из URL
async function loadMaps() {
    // 1. Загружаем PK3 файл
    const response = await fetch('assets/maps.pk3');
    const arrayBuffer = await response.arrayBuffer();
    
    // 2. Парсим как ZIP
    const zip = await JSZip.loadAsync(arrayBuffer);
    
    // 3. Загружаем в виртуальную файловую систему
    await syscallHandler.loadPK3Archive(zip, 'maps.pk3');
    
    // 4. Предзагружаем все .bsp карты
    await syscallHandler.preloadFilesByPattern('maps/.*\\.bsp$');
    
    console.log('✓ Карты загружены!');
}

loadMaps();
```

### 3. Загрузка пользовательского файла

```html
<input type="file" id="mapFile" accept=".pk3,.zip">
<button onclick="loadCustomMaps()">Загрузить карты</button>

<script>
async function loadCustomMaps() {
    const file = document.getElementById('mapFile').files[0];
    if (!file) return;
    
    // Читаем файл
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);
    
    // Загружаем в VFS
    await syscallHandler.loadPK3Archive(zip, file.name);
    
    // Предзагружаем карты
    await syscallHandler.preloadFilesByPattern('maps/.*\\.bsp$');
    
    alert('Карты загружены!');
}
</script>
```

## Структура вашего PK3/ZIP файла

Ваш архив должен содержать карты в папке `maps/`:

```
maps.pk3 (или maps.zip)
└── maps/
    ├── q3dm1.bsp
    ├── q3dm2.bsp
    └── mymap.bsp
```

## Проверка загруженных карт

```javascript
// Список всех загруженных карт
function listLoadedMaps() {
    for (const archive of syscallHandler.vfs.pk3Archives) {
        console.log(`Архив: ${archive.name}`);
        
        archive.zip.forEach((path, file) => {
            if (path.startsWith('maps/') && path.endsWith('.bsp')) {
                const mapName = path.replace('maps/', '').replace('.bsp', '');
                console.log(`  - ${mapName}`);
            }
        });
    }
}
```

## Полный пример интеграции

```javascript
// Создаем syscall handler
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const syscallHandler = new Q3VMSyscallHandler(canvas, ctx);

// Создаем и инициализируем VM
const vm = new Q3VMWasm();
await vm.initialize();
vm.setSyscallHandler(syscallHandler);
syscallHandler.bindToVM(vm);

// Загружаем QVM модуль
const qvmData = await loadQVMFile('assets/vm/cgame/cgame.qvm');
await vm.loadModule(qvmData);

// ТЕПЕРЬ загружаем карты ПЕРЕД инициализацией cgame
const response = await fetch('assets/maps.pk3');
const arrayBuffer = await response.arrayBuffer();
const zip = await JSZip.loadAsync(arrayBuffer);
await syscallHandler.loadPK3Archive(zip, 'maps.pk3');

// Предзагружаем карты для быстрого доступа
await syscallHandler.preloadFilesByPattern('maps/.*\\.bsp$');

// Теперь инициализируем cgame (он сможет находить карты)
const result = vm.call(0, 0, 0, 0); // CG_INIT
console.log('CG_Init result:', result);
```

## Отладка

Включите логирование VFS для отладки:

```javascript
// В консоли браузера смотрите:
// [VFS] Загружен PK3 архив: maps.pk3 (X файлов)
// [VFS] Предзагружен: maps/q3dm1.bsp (Y байт)
// [FS] Открыт файл: maps/q3dm1.bsp (handle=1, size=Y)
// [FS] Закрыт файл: maps/q3dm1.bsp (handle=1)
```

## Устранение проблем

### Файл не найден
- Убедитесь что карты в папке `maps/` внутри PK3
- Проверьте что файлы предзагружены перед использованием
- Используйте `listLoadedMaps()` чтобы увидеть доступные карты

### Handle ошибки
- Убедитесь что PK3 загружен ДО инициализации cgame
- Предзагрузите файлы используя `preloadFilesByPattern()`

### JSZip не найден
Добавьте в HTML:
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
```

## Требования

- Браузер с поддержкой WebAssembly
- JSZip библиотека (для распаковки PK3/ZIP)
- Q3VM WASM wrapper
- Q3VM Syscall Handler

## Дополнительно

См. также:
- `scripts/vfs-example.js` - Подробные примеры
- `scripts/modules/q3vm-syscalls.js` - Реализация VFS





