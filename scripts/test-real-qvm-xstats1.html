<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Real QVM xstats1 Test v0.047 ‚úÖ Version Fix!</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 10px;
            margin: 0;
        }
        
        h1 {
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
        }
        
        .panel {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #0f0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .panel h2 {
            color: #ff0;
            margin-top: 0;
        }
        
        button {
            background: #0a0;
            color: #000;
            border: 2px solid #0f0;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        
        button:hover {
            background: #0f0;
            box-shadow: 0 0 15px #0f0;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
            font-weight: bold;
        }
        
        .status.ok {
            background: #0a0;
            color: #000;
        }
        
        .status.error {
            background: #a00;
            color: #fff;
        }
        
        .status.pending {
            background: #aa0;
            color: #000;
        }
        
        #console {
            background: #000;
            border: 2px solid #0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 11px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .log {
            margin: 3px 0;
            padding: 3px 5px;
        }
        
        .log-server { color: #0ff; }
        .log-bridge { color: #f0f; }
        .log-qvm { color: #ff0; }
        .log-success { color: #0f0; font-weight: bold; }
        .log-error { color: #f00; font-weight: bold; }
        .log-info { color: #888; }
        
        .big-button {
            width: 100%;
            padding: 20px;
            font-size: 18px;
        }
        
        .info-box {
            background: rgba(0, 50, 100, 0.2);
            border-left: 4px solid #0ff;
            padding: 15px;
            margin: 15px 0;
        }
        
        #q3console {
            background: #000;
            border: 2px solid #0a0;
            padding: 8px;
            height: 350px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #0f0;
            margin-top: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #cmdInput {
            width: calc(100% - 100px);
            background: #000;
            border: 2px solid #0a0;
            color: #0f0;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        #sendCmdBtn {
            width: 90px;
            padding: 8px;
            margin-left: 5px;
        }
        
        #q3console::-webkit-scrollbar {
            width: 8px;
        }
        
        #q3console::-webkit-scrollbar-track {
            background: #000;
        }
        
        #q3console::-webkit-scrollbar-thumb {
            background: #0a0;
            border-radius: 4px;
        }
        
        .q3-line {
            margin: 1px 0;
            padding: 1px 0;
        }
        
        .q3-init { color: #0ff; }
        .q3-warning { color: #ff0; }
        .q3-error { color: #f00; }
        .q3-command { color: #f0f; }
    </style>
</head>
<body>
    <h1 style="margin: 10px 0;">üéÆ Real QVM xstats1 Test</h1>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: Canvas –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div>
            <div class="panel" style="padding: 8px; margin: 5px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                    <div><strong>QVM:</strong> <span id="qvmStatus" class="status pending">-</span></div>
                    <div><strong>–°–Ω–∞–ø—à–æ—Ç—ã:</strong> <span id="snapshotStatus" style="font-size: 11px; color: #666;">-</span></div>
                </div>
            </div>
            
            <div class="panel" style="padding: 10px; margin: 5px 0;">
                <button onclick="initAndStartQ3VMClient()" style="background: #0a0; font-size: 13px; padding: 8px 16px; width: 100%;">üéÆ –ó–ê–ü–£–°–¢–ò–¢–¨ QVM</button>
                <canvas id="clientCanvas" width="640" height="480" style="width: 100%; max-height: 360px; border: 2px solid #0f0; display: block; margin: 8px 0; background: #000;"></canvas>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–æ–Ω—Å–æ–ª—å –∏ —Ç–µ—Å—Ç—ã -->
        <div>
            <div class="panel" style="padding: 10px; margin: 5px 0;">
                <h3 style="margin: 0 0 8px 0; font-size: 14px;">üì§ –ö–æ–º–∞–Ω–¥—ã</h3>
                <div style="margin-bottom: 8px;">
                    <input type="text" id="cmdInput" placeholder='–ö–æ–º–∞–Ω–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: cp "Hello!")'/>
                    <button id="sendCmdBtn" onclick="sendCustomCommand()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
                <button onclick="testSimpleCommand()" style="width: 48%; padding: 8px; margin: 2px; font-size: 12px;">üß™ Test CP</button>
                <button onclick="runFullTest()" style="width: 48%; padding: 8px; margin: 2px; font-size: 12px;">‚ñ∂Ô∏è XSTATS1</button>
            </div>
            
            <div class="panel" style="padding: 10px; margin: 5px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <h3 style="margin: 0; font-size: 14px;">üéÆ Q3 Console</h3>
                    <button onclick="clearQ3Console()" style="padding: 4px 8px; font-size: 11px;">üóëÔ∏è</button>
                </div>
                <div id="q3console"></div>
            </div>
        </div>
    </div>
    
    <!-- JSZip –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ PK3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Q3VM WASM (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) - 33x –±—ã—Å—Ç—Ä–µ–µ! -->
    <script src="modules/q3vm-wasm.js?v=1.0.0"></script>
    <script src="modules/q3vm-wasm-wrapper.js?v=1.0.5"></script>
    
    <!-- Q3VM JS –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä (fallback) -->
    <script src="modules/q3vm-core.js?v=1.0.0"></script>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π -->
    <script src="modules/q3-server-emulator.js?v=0.047"></script>
    <script src="modules/q3vm-syscalls.js?v=0.047"></script>
    <script src="modules/server-qvm-bridge.js?v=0.047"></script>
    
    <!-- Q3VM Client –º–æ–¥—É–ª–∏ -->
    <script src="modules/q3vm-loader.js?v=0.047"></script>
    <script src="modules/q3vm-client-integration-v2.js?v=0.047"></script>
    
    <script>
        let lastSnapshotCount = 0;
        let q3consoleDiv = document.getElementById('q3console');
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        window.logSnapshot = function(message) {
            lastSnapshotCount++;
            const snapshotStatus = document.getElementById('snapshotStatus');
            if (snapshotStatus) {
                snapshotStatus.textContent = `#${lastSnapshotCount}`;
                snapshotStatus.style.color = '#0f0';
            }
        };
        
        // –í—ã–≤–æ–¥ –≤ Q3 –∫–æ–Ω—Å–æ–ª—å
        window.q3Print = function(text) {
            if (!q3consoleDiv) {
                q3consoleDiv = document.getElementById('q3console');
            }
            const line = document.createElement('div');
            line.className = 'q3-line';
            line.textContent = text;
            q3consoleDiv.appendChild(line);
            q3consoleDiv.scrollTop = q3consoleDiv.scrollHeight;
        };
        
        // –û—á–∏—Å—Ç–∫–∞ Q3 –∫–æ–Ω—Å–æ–ª–∏
        window.clearQ3Console = function() {
            if (!q3consoleDiv) {
                q3consoleDiv = document.getElementById('q3console');
            }
            q3consoleDiv.innerHTML = '';
            window.q3Print('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            window.q3Print('‚ïë       Q3 CONSOLE - QVM Output Display                     ‚ïë');
            window.q3Print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            window.q3Print('');
        };
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è log() (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function log(message, className) {
            // –ù–µ –≤—ã–≤–æ–¥–∏–º, —Ç–∞–∫ –∫–∞–∫ debug –∫–æ–Ω—Å–æ–ª—å —É–¥–∞–ª–µ–Ω–∞
        }
        
        function setStatus(elementId, text, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = text;
                el.className = `status ${type}`;
            }
        }
        
        function checkStatus() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...', 'log-info');
            
            // Server Emulator
            if (window.serverEmulator) {
                setStatus('serverStatus', '–ì–æ—Ç–æ–≤', 'ok');
                log('‚úì Server Emulator –Ω–∞–π–¥–µ–Ω', 'log-success');
            } else {
                setStatus('serverStatus', '–ù–µ –Ω–∞–π–¥–µ–Ω', 'error');
                log('‚úó Server Emulator –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
            }
            
            // QVM Syscalls
            if (window.qvmSyscalls) {
                setStatus('syscallsStatus', '–ì–æ—Ç–æ–≤', 'ok');
                log('‚úì QVM Syscalls –Ω–∞–π–¥–µ–Ω', 'log-success');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è addServerCommand
                if (typeof window.qvmSyscalls.addServerCommand === 'function') {
                    log('  ‚úì addServerCommand() –¥–æ—Å—Ç—É–ø–µ–Ω', 'log-success');
                } else {
                    log('  ‚úó addServerCommand() –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
                }
            } else {
                setStatus('syscallsStatus', '–ù–µ –Ω–∞–π–¥–µ–Ω', 'error');
                log('‚úó QVM Syscalls –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
                log('  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ QVM –∫–ª–∏–µ–Ω—Ç —Å–Ω–∞—á–∞–ª–∞', 'log-info');
            }
            
            // QVM Client
            if (window.cgameVM) {
                setStatus('qvmStatus', '–ó–∞–≥—Ä—É–∂–µ–Ω', 'ok');
                log('‚úì QVM Client –Ω–∞–π–¥–µ–Ω', 'log-success');
            } else {
                setStatus('qvmStatus', '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                log('‚úó QVM Client –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
            }
            
            // Bridge
            if (window.serverQVMBridge && window.serverQVMBridge.isConnected) {
                setStatus('bridgeStatus', '–ü–æ–¥–∫–ª—é—á–µ–Ω', 'ok');
                log('‚úì –ú–æ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω', 'log-success');
            } else {
                setStatus('bridgeStatus', '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                log('‚úó –ú–æ—Å—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'log-error');
            }
        }
        
        function connectBridge() {
            log('üîó –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–æ—Å—Ç...', 'log-bridge');
            
            if (window.connectServerToQVM) {
                const result = window.connectServerToQVM();
                if (result) {
                    log('‚úì –ú–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!', 'log-success');
                    setStatus('bridgeStatus', '–ü–æ–¥–∫–ª—é—á–µ–Ω', 'ok');
                } else {
                    log('‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–æ—Å—Ç', 'log-error');
                }
            } else {
                log('‚úó connectServerToQVM() –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
            }
            
            checkStatus();
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–∫–∞–∫ –≤ superhud-tools)
        window.globalQ3Server = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ Q3VM –∫–ª–∏–µ–Ω—Ç–∞
        window.initAndStartQ3VMClient = async function() {
            const canvas = document.getElementById('clientCanvas');
            
            if (!canvas) {
                log('‚úó Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'log-error');
                return;
            }
            
            try {
                log('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Q3VM –∫–ª–∏–µ–Ω—Ç–∞...', 'log-info');
                
                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç (–Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º!)
                if (!window.globalQ3Server) {
                    log('  –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞...', 'log-info');
                    window.globalQ3Server = window.serverEmulator;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ä–∞–∑)
                if (!globalQ3Server.players.has(0)) {
                    log('  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ TestWarrior...', 'log-info');
                    globalQ3Server.addPlayer(0, 'TestWarrior');
                }
                
                // –í–ê–ñ–ù–û: connectClient —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –í–ù–£–¢–†–ò createQ3VMClientV2 –î–û –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ QVM
                // –≠—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã configstrings –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ CG_Init –≤—ã–∑–æ–≤–µ—Ç trap_GetGameState
                // –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å connectClient –∑–¥–µ—Å—å!
                
                log('  –ó–∞–≥—Ä—É–∑–∫–∞ Q3VM...', 'log-qvm');
                setStatus('qvmStatus', '–ó–∞–≥—Ä—É–∑–∫–∞...', 'pending');
                
                // –°–æ–∑–¥–∞–µ–º Q3VM –∫–ª–∏–µ–Ω—Ç (–∏–∑ q3vm-client-integration-v2.js)
                // –í–Ω—É—Ç—Ä–∏ createQ3VMClientV2:
                //   1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è callback)
                //   2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è connectClient (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è configstrings)
                //   3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è initialize() (CG_Init –ø–æ–ª—É—á–∞–µ—Ç configstrings)
                const q3vmClient = await createQ3VMClientV2(canvas, globalQ3Server);
                
                if (!q3vmClient) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Q3VM –∫–ª–∏–µ–Ω—Ç');
                }
                
                log('  ‚úì Q3VM –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω', 'log-success');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
                window.cgameVM = q3vmClient.vm;
                window.qvmSyscalls = q3vmClient.syscallHandler;  // ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—è!
                window.q3vmClient = q3vmClient;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º syscalls
                if (!q3vmClient.syscallHandler) {
                    throw new Error('Syscalls –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ QVM –∫–ª–∏–µ–Ω—Ç–µ');
                }
                log('  ‚úì Syscalls –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'log-success');
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ—Å—Ç –ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞!
                if (window.serverQVMBridge) {
                    const bridgeResult = window.serverQVMBridge.connect(globalQ3Server, q3vmClient.syscallHandler);
                    if (bridgeResult) {
                        setStatus('bridgeStatus', '–ü–æ–¥–∫–ª—é—á–µ–Ω', 'ok');
                        log('  ‚úì –ú–æ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω', 'log-success');
                    }
                } else {
                    log('  ‚ö†Ô∏è serverQVMBridge –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-warning');
                }
                
                // –¢–ï–ü–ï–†–¨ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä (callback —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!)
                if (!globalQ3Server.isRunning) {
                    log('  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1000ms (1 —Å–Ω–∞–ø—à–æ—Ç/—Å–µ–∫)...', 'log-info');
                    globalQ3Server.start(1000); // 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏
                }
                
                const clientStatus = q3vmClient.getStatus();
                log(`  ‚úì –¢–∏–ø VM: ${clientStatus.vmType ? clientStatus.vmType.toUpperCase() : 'Unknown'}`, 'log-success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
                q3vmClient.startRendering();
                
                const vmTypeEmoji = clientStatus.vmType === 'wasm' ? 'üöÄ' : 'üêå';
                setStatus('qvmStatus', `${vmTypeEmoji} ${clientStatus.vmType ? clientStatus.vmType.toUpperCase() : ''} —Ä–∞–±–æ—Ç–∞–µ—Ç`, 'ok');
                setStatus('syscallsStatus', '–ì–æ—Ç–æ–≤', 'ok');
                setStatus('serverStatus', '–†–∞–±–æ—Ç–∞–µ—Ç', 'ok');
                
                log('‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Ç–æ–≤—ã! –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å xstats1', 'log-success');
                log(`  window.qvmSyscalls = ${window.qvmSyscalls ? '‚úì —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úó null'}`, 'log-info');
                log(`  window.cgameVM = ${window.cgameVM ? '‚úì —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úó null'}`, 'log-info');
                
            } catch (error) {
                log(`‚úó –û—à–∏–±–∫–∞: ${error.message}`, 'log-error');
                setStatus('qvmStatus', '–û—à–∏–±–∫–∞', 'error');
                console.error('[Q3VM] –û—à–∏–±–∫–∞:', error);
            }
        }
        
        // –í—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ QVM –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã
        function callRealQVM() {
            if (!window.qvmSyscalls) {
                log('‚úó QVM Syscalls –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
                return;
            }
            
            if (!window.cgameVM || !window.cgameVM.vmMain) {
                log('‚ö†Ô∏è –†–µ–∞–ª—å–Ω—ã–π QVM –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'log-info');
                log('   Syscalls –≥–æ—Ç–æ–≤—ã - –∫–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å', 'log-info');
                log('   –ö–æ–≥–¥–∞ QVM –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –æ–Ω —Å–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑:', 'log-info');
                log('   ‚Üí trap_GetServerCommand()', 'log-info');
                log('   ‚Üí trap_Argc() / trap_Argv()', 'log-info');
                log('   ‚Üí CG_Printf() –¥–ª—è –≤—ã–≤–æ–¥–∞ (trap_Print)', 'log-info');
                log('\n<strong>üí° –î–ª—è –≤—ã–∑–æ–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ QVM –∏—Å–ø–æ–ª—å–∑—É–π:</strong>', 'log-info');
                log('   <code>triggerQVMServerCommand()</code> - –≤—ã–∑–æ–≤–µ—Ç CG_ExecuteNewServerCommands –≤ QVM', 'log-info');
                return;
            }
            
            log('\n<strong>[QVM]</strong> üéÆ –í—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ QVM...', 'log-qvm');
            
            const latestSequence = window.qvmSyscalls.serverCommandSequence;
            
            log(`<strong>[QVM]</strong> –ö–æ–º–∞–Ω–¥–∞ –≤ –æ—á–µ—Ä–µ–¥–∏: sequence=${latestSequence}`, 'log-qvm');
            log(`<strong>[QVM]</strong> –í—ã–∑—ã–≤–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –≤ QVM...`, 'log-qvm');
            
            // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –≤ QVM
            triggerQVMServerCommand();
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        window.sendCustomCommand = function() {
            if (!window.qvmSyscalls) {
                window.q3Print('‚úó QVM –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ó–ê–ü–£–°–¢–ò–¢–¨ QVM"');
                return;
            }
            
            const input = document.getElementById('cmdInput');
            const cmd = input.value.trim();
            
            if (!cmd) {
                window.q3Print('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É');
                return;
            }
            
            window.q3Print('');
            window.q3Print('‚îÅ‚îÅ‚îÅ üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã ‚îÅ‚îÅ‚îÅ');
            window.q3Print(`> ${cmd}`);
            
            window.qvmSyscalls.addServerCommand(cmd);
            
            window.q3Print(`‚úì –ö–æ–º–∞–Ω–¥–∞ #${window.qvmSyscalls.serverCommandSequence} –≤ –æ—á–µ—Ä–µ–¥–∏`);
            window.q3Print('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            window.q3Print('');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
        };
        
        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('cmdInput');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendCustomCommand();
                    }
                });
            }
        });
        
        // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É "cp" (center print)
        window.testSimpleCommand = function() {
            if (!window.qvmSyscalls) {
                window.q3Print('‚úó QVM –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ó–ê–ü–£–°–¢–ò–¢–¨ QVM"');
                return;
            }
            
            window.q3Print('');
            window.q3Print('‚îÅ‚îÅ‚îÅ üß™ –¢–µ—Å—Ç: cp ‚îÅ‚îÅ‚îÅ');
            window.qvmSyscalls.addServerCommand('cp "^2Hello from QVM!"');
            window.q3Print(`‚úì –ö–æ–º–∞–Ω–¥–∞ #${window.qvmSyscalls.serverCommandSequence}`);
            window.q3Print('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            window.q3Print('');
        };
        
        // –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –≤—ã–∑–æ–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –≤ QVM
        window.triggerQVMServerCommand = function() {
            if (!window.q3vmClient) {
                log('‚úó QVM Client –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ó–ê–ü–£–°–¢–ò–¢–¨ Q3VM –ö–õ–ò–ï–ù–¢"', 'log-error');
                console.error('[QVM] QVM Client –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
                return false;
            }
            
            if (!window.qvmSyscalls) {
                log('‚úó QVM Syscalls –Ω–µ –Ω–∞–π–¥–µ–Ω', 'log-error');
                console.error('[QVM] QVM Syscalls –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            const latestSequence = window.qvmSyscalls.serverCommandSequence;
            
            log(`\n<strong>[QVM]</strong> üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (sequence=${latestSequence})...`, 'log-qvm');
            console.log(`[QVM] –í—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (sequence=${latestSequence})...`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –æ—á–µ—Ä–µ–¥–∏
            if (latestSequence === 0) {
                log('‚ö†Ô∏è –ù–µ—Ç –∫–æ–º–∞–Ω–¥ –≤ –æ—á–µ—Ä–µ–¥–∏. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ó–ê–ü–£–°–¢–ò–¢–¨ –¢–ï–°–¢ XSTATS1"', 'log-warning');
                return false;
            }
            
            try {
                const serverTime = window.q3vmClient.serverTime || (Date.now() - window.qvmSyscalls.startTime);
                
                log(`<strong>[QVM]</strong> üéØ –í—ã–∑–æ–≤ CG_DRAW_ACTIVE_FRAME (serverTime=${serverTime})`, 'log-info');
                log(`  –°–Ω–∞–ø—à–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç: serverCommandSequence=${latestSequence}`, 'log-info');
                log(`  QVM –≤—ã–∑–æ–≤–µ—Ç CG_ExecuteNewServerCommands(${latestSequence})`, 'log-info');
                console.log(`[QVM] –í—ã–∑–æ–≤: CG_DRAW_ACTIVE_FRAME(${serverTime}, 0)`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º WASM wrapper –Ω–∞–ø—Ä—è–º—É—é
                let result;
                if (window.q3vmClient.vm && window.q3vmClient.vm.call) {
                    // WASM VM - –∏—Å–ø–æ–ª—å–∑—É–µ–º wrapper.call(ignored, command, ...args)
                    // –ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, —Ä–µ–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤ args[0]!
                    // CG_DRAW_ACTIVE_FRAME = 3, args: serverTime, stereoView
                    result = window.q3vmClient.vm.call(0, 3, serverTime, 0);
                    console.log(`[QVM] ‚úì WASM VM call –≤—ã–ø–æ–ª–Ω–µ–Ω, result=${result}`);
                } else if (window.cgameVM && window.cgameVM.vmMain) {
                    // JS VM - –∏—Å–ø–æ–ª—å–∑—É–µ–º vmMain
                    result = window.cgameVM.vmMain(3, serverTime, 0);
                    console.log(`[QVM] ‚úì JS VM call –≤—ã–ø–æ–ª–Ω–µ–Ω, result=${result}`);
                } else {
                    throw new Error('VM –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ call() –∏–ª–∏ vmMain()');
                }
                
                log(`<strong>[QVM]</strong> ‚úì VM call –≤—ã–ø–æ–ª–Ω–µ–Ω, result=${result}`, 'log-success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞
                setTimeout(() => {
                    log('\n<strong>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã:</strong>', 'log-info');
                    log(`  –ö–æ–º–∞–Ω–¥ –≤ –æ—á–µ—Ä–µ–¥–∏: ${window.qvmSyscalls.serverCommands.length}`, 'log-info');
                    log(`  –ü–æ—Å–ª–µ–¥–Ω—è—è sequence: ${latestSequence}`, 'log-info');
                    log(`  –¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞: ${window.qvmSyscalls.currentCommand ? window.qvmSyscalls.currentCommand.commandString.substring(0, 40) : '–Ω–µ—Ç'}`, 'log-info');
                    
                    const cmd = window.qvmSyscalls.serverCommands.find(c => c.sequence === latestSequence);
                    if (cmd) {
                        console.log('[QVM] ‚úì –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥–∏:', cmd.commandString.substring(0, 60));
                        log(`  –ö–æ–º–∞–Ω–¥–∞ –≤ –æ—á–µ—Ä–µ–¥–∏: ${cmd.commandString.substring(0, 40)}...`, 'log-success');
                    }
                    
                    log('\n<strong>üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è:</strong>', 'log-info');
                    log('  ‚Ä¢ [QVM SYSCALL] ‚úì GetServerCommand(...) - –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞', 'log-info');
                    log('  ‚Ä¢ [QVM Print] ... - –≤—ã–≤–æ–¥ –∏–∑ CG_Printf', 'log-info');
                    log('\n<strong>‚ö†Ô∏è –ï—Å–ª–∏ —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç:</strong>', 'log-warning');
                    log('  ‚Üí QVM –Ω–µ –≤—ã–∑–≤–∞–ª CG_ExecuteNewServerCommands', 'log-warning');
                    log('  ‚Üí –í–æ–∑–º–æ–∂–Ω–æ cgs.serverCommandSequence —É–∂–µ —Ä–∞–≤–µ–Ω ' + latestSequence, 'log-warning');
                }, 200);
                
                return true;
            } catch (error) {
                console.error('[QVM] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ VM:', error);
                log(`<strong>[QVM]</strong> ‚úó –û—à–∏–±–∫–∞: ${error.message}`, 'log-error');
                return false;
            }
        };
        
        function runFullTest() {
            if (!window.qvmSyscalls) {
                window.q3Print('‚úó QVM –Ω–µ –∑–∞–ø—É—â–µ–Ω');
                return;
            }
            
            window.q3Print('');
            window.q3Print('‚îÅ‚îÅ‚îÅ ‚ñ∂Ô∏è XSTATS1 ‚îÅ‚îÅ‚îÅ');
            sendXStats1(0, 0);
            window.q3Print(`‚úì –ö–æ–º–∞–Ω–¥–∞ #${window.qvmSyscalls.serverCommandSequence}`);
            window.q3Print('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            window.q3Print('');
        }
        
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ Q3 –∫–æ–Ω—Å–æ–ª–∏
            window.q3Print('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            window.q3Print('‚ïë       Q3 CONSOLE - QVM Output Display                     ‚ïë');
            window.q3Print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            window.q3Print('');
            window.q3Print('Waiting for QVM initialization...');
            window.q3Print('');
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä —Å—Ä–∞–∑—É
            window.globalQ3Server = window.serverEmulator;
        });
    </script>
</body>
</html>

