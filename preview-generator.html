<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор превью изображений</title>
    <link rel="icon" href="/assets/blender_180.png" type="image/png">
    <link rel="stylesheet" href="/styles/style.css?v=1.3">
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #6a6a6a;
        }
        .button:disabled {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .button-primary {
            background: #0066cc;
        }
        .button-primary:hover {
            background: #0088ff;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #0066cc;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .preview-item {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .preview-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .preview-item .info {
            font-size: 12px;
            color: #aaa;
            margin: 5px 0;
        }
        .download-link {
            display: inline-block;
            margin-top: 5px;
            color: #0066cc;
            text-decoration: none;
        }
        .download-link:hover {
            text-decoration: underline;
        }
        .compilation-section {
            margin: 30px 0;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        .compilation-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0066cc;
        }
        .compilation-selection {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .compilation-selection.active {
            display: block;
        }
        .compilation-selection h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #0066cc;
        }
        .selection-controls {
            margin-bottom: 15px;
        }
        .compilation-checkbox {
            margin: 10px 0;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .compilation-checkbox:hover {
            background: #3a3a3a;
        }
        .compilation-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        .compilation-checkbox label {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Генератор превью изображений (50% качество)</h1>
        
        <div class="controls">
            <button id="loadCompilationsBtn" class="button button-primary">Загрузить сборки</button>
            <button id="loadGalleryBtn" class="button button-primary">Загрузить галерею</button>
            <button id="processBtn" class="button" disabled>Обработать выбранные изображения</button>
            <button id="downloadAllBtn" class="button" disabled>Скачать все обработанные (ZIP)</button>
            <button id="downloadSelectedBtn" class="button" disabled>Скачать выбранные сборки (ZIP)</button>
            
            <div class="status" id="status">Выберите источник изображений</div>
            <div class="progress" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
        </div>
        
        <div class="compilation-selection" id="compilationSelection">
            <h3>Выберите сборки для обработки:</h3>
            <div class="selection-controls">
                <button id="selectAllBtn" class="button" style="margin-right: 10px;">Выбрать все</button>
                <button id="deselectAllBtn" class="button">Снять выделение</button>
            </div>
            <div id="compilationCheckboxes"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let compilationsConfig = {};
        let galleryConfig = {};
        let currentMode = null; // 'compilations' or 'gallery'
        let processedImages = [];
        let allProcessedImages = [];

        document.getElementById('loadCompilationsBtn').addEventListener('click', async () => {
            const statusEl = document.getElementById('status');
            const processBtn = document.getElementById('processBtn');
            const selectionEl = document.getElementById('compilationSelection');
            const checkboxesContainer = document.getElementById('compilationCheckboxes');
            const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
            
            try {
                statusEl.textContent = 'Загрузка конфигурации сборок...';
                const response = await fetch('/images/compilations-config.json');
                compilationsConfig = await response.json();
                galleryConfig = {}; // Очищаем конфигурацию галереи
                currentMode = 'compilations';
                
                // Создаем чекбоксы для каждой сборки
                checkboxesContainer.innerHTML = '';
                Object.keys(compilationsConfig).forEach(compilation => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'compilation-checkbox';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox-${compilation}`;
                    checkbox.value = compilation;
                    checkbox.checked = true; // По умолчанию все выбраны
                    
                    const label = document.createElement('label');
                    label.htmlFor = `checkbox-${compilation}`;
                    const config = compilationsConfig[compilation];
                    label.textContent = `${compilation} (${config.count} изображений, ${config.extension})`;
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxesContainer.appendChild(checkboxDiv);
                });
                
                selectionEl.classList.add('active');
                downloadSelectedBtn.disabled = true; // Активируется после обработки
                statusEl.textContent = `Загружено сборок: ${Object.keys(compilationsConfig).length}`;
                processBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `Ошибка загрузки: ${error.message}`;
                console.error(error);
            }
        });

        document.getElementById('loadGalleryBtn').addEventListener('click', async () => {
            const statusEl = document.getElementById('status');
            const processBtn = document.getElementById('processBtn');
            const selectionEl = document.getElementById('compilationSelection');
            const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
            
            try {
                statusEl.textContent = 'Загрузка конфигурации галереи...';
                const response = await fetch('/images/gallery-config.json');
                galleryConfig = await response.json();
                compilationsConfig = {}; // Очищаем конфигурацию сборок
                currentMode = 'gallery';
                
                // Скрываем выбор сборок для режима галереи
                selectionEl.classList.remove('active');
                downloadSelectedBtn.disabled = true; // Не доступна для галереи
                
                const imageCount = galleryConfig.images ? galleryConfig.images.length : 0;
                statusEl.textContent = `Загружено изображений галереи: ${imageCount}`;
                processBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `Ошибка загрузки: ${error.message}`;
                console.error(error);
            }
        });

        // Кнопки выбора всех / снятия выделения
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#compilationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        });

        document.getElementById('deselectAllBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#compilationCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        });

        document.getElementById('processBtn').addEventListener('click', async () => {
            const statusEl = document.getElementById('status');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const processBtn = document.getElementById('processBtn');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const resultsEl = document.getElementById('results');
            
            if (!currentMode) {
                statusEl.textContent = 'Сначала загрузите конфигурацию сборок или галереи';
                return;
            }
            
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            resultsEl.innerHTML = '';
            allProcessedImages = [];
            
            if (currentMode === 'compilations') {
                await processCompilations(statusEl, progressBar, processBtn, downloadAllBtn, resultsEl);
            } else if (currentMode === 'gallery') {
                await processGallery(statusEl, progressBar, processBtn, downloadAllBtn, resultsEl);
            }
            
            progressContainer.style.display = 'none';
            processBtn.disabled = false;
            downloadAllBtn.disabled = false;
            
            // Активируем кнопку скачивания выбранных сборок для режима сборок
            if (currentMode === 'compilations') {
                const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
                downloadSelectedBtn.disabled = allProcessedImages.length === 0;
            }
        });

        function getSelectedCompilations() {
            const checkboxes = document.querySelectorAll('#compilationCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function processCompilations(statusEl, progressBar, processBtn, downloadAllBtn, resultsEl) {
            const selectedCompilations = getSelectedCompilations();
            
            if (selectedCompilations.length === 0) {
                statusEl.textContent = 'Выберите хотя бы одну сборку для обработки';
                processBtn.disabled = false;
                return;
            }
            
            let totalImages = 0;
            let processedCount = 0;
            
            // Подсчет общего количества изображений только для выбранных сборок
            for (const compilation of selectedCompilations) {
                totalImages += compilationsConfig[compilation].count;
            }
            
            statusEl.textContent = `Обработка ${totalImages} изображений из ${selectedCompilations.length} сборок...`;
            
            for (const compilation of selectedCompilations) {
                const config = compilationsConfig[compilation];
                const section = document.createElement('div');
                section.className = 'compilation-section';
                section.innerHTML = `
                    <div class="compilation-title">${compilation}</div>
                    <button class="button button-primary" style="margin-bottom: 10px;" data-compilation="${compilation}">Скачать ZIP для ${compilation}</button>
                    <div class="preview-grid" id="${compilation}-grid"></div>
                `;
                resultsEl.appendChild(section);
                
                const gridEl = document.getElementById(`${compilation}-grid`);
                const downloadBtn = section.querySelector(`[data-compilation="${compilation}"]`);
                
                // Кнопка изначально неактивна, станет активной после обработки
                downloadBtn.disabled = true;
                
                // Обработчик для кнопки скачивания конкретной сборки
                downloadBtn.addEventListener('click', async () => {
                    downloadBtn.disabled = true;
                    await downloadCompilationZip(compilation);
                    downloadBtn.disabled = false;
                });
                
                processedImages = [];
                
                for (let i = 1; i <= config.count; i++) {
                    const imagePath = `/images/${compilation}/${i}.${config.extension}`;
                    const thumbnailPath = `/images/${compilation}/thumbnails/${i}.jpg`;
                    
                    // Сначала проверяем существование исходного файла
                    const originalExists = await checkFileExists(imagePath);
                    if (!originalExists) {
                        // Файл не существует - пропускаем тихо
                        const skippedItem = document.createElement('div');
                        skippedItem.className = 'preview-item';
                        skippedItem.style.opacity = '0.5';
                        skippedItem.innerHTML = `
                            <div class="info" style="color: #666;">${compilation}/${i}.${config.extension}</div>
                            <div class="info" style="color: #666;">Файл не найден</div>
                        `;
                        gridEl.appendChild(skippedItem);
                        
                        processedCount++;
                        const progress = (processedCount / totalImages) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${Math.round(progress)}%`;
                        statusEl.textContent = `Пропущено (не найден): ${compilation}/${i}.${config.extension} | Обработано: ${processedCount} / ${totalImages}`;
                        continue;
                    }
                    
                    // Проверка существования thumbnail файла
                    const thumbnailExists = await checkFileExists(thumbnailPath);
                    
                    if (thumbnailExists) {
                        // Пропускаем, если thumbnail уже существует
                        const skippedItem = document.createElement('div');
                        skippedItem.className = 'preview-item';
                        skippedItem.style.opacity = '0.6';
                        skippedItem.innerHTML = `
                            <div class="info" style="color: #888;">${compilation}/thumbnails/${i}.jpg</div>
                            <div class="info" style="color: #888;">Пропущено (уже существует)</div>
                        `;
                        gridEl.appendChild(skippedItem);
                        
                        processedCount++;
                        const progress = (processedCount / totalImages) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${Math.round(progress)}%`;
                        statusEl.textContent = `Пропущено (уже существует): ${compilation}/thumbnails/${i}.jpg | Обработано: ${processedCount} / ${totalImages}`;
                        continue;
                    }
                    
                    try {
                        const processed = await processImage(imagePath, compilation, i, config.extension, 'compilations');
                        if (processed) {
                            processedImages.push(processed);
                            allProcessedImages.push(processed);
                            
                            // Создание элемента превью
                            const previewItem = document.createElement('div');
                            previewItem.className = 'preview-item';
                            previewItem.innerHTML = `
                                <img src="${processed.previewUrl}" alt="${compilation} ${i}">
                                <div class="info">${compilation}/${i}.${config.extension}</div>
                                <div class="info">Оригинал: ${(processed.originalSize / 1024).toFixed(2)} KB</div>
                                <div class="info">Превью: ${(processed.previewSize / 1024).toFixed(2)} KB</div>
                                <a href="${processed.previewUrl}" download="${processed.filename}" class="download-link">Скачать</a>
                            `;
                            gridEl.appendChild(previewItem);
                            
                            processedCount++;
                            const progress = (processedCount / totalImages) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${Math.round(progress)}%`;
                            statusEl.textContent = `Обработано: ${processedCount} / ${totalImages}`;
                        }
                    } catch (error) {
                        // Показываем ошибку в UI
                        const errorItem = document.createElement('div');
                        errorItem.className = 'preview-item';
                        errorItem.style.opacity = '0.5';
                        errorItem.innerHTML = `
                            <div class="info" style="color: #cc6666;">${compilation}/${i}.${config.extension}</div>
                            <div class="info" style="color: #cc6666;">Ошибка: ${error.message || 'Неизвестная ошибка'}</div>
                        `;
                        gridEl.appendChild(errorItem);
                        
                        processedCount++;
                        const progress = (processedCount / totalImages) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${Math.round(progress)}%`;
                        statusEl.textContent = `Ошибка обработки ${compilation}/${i}.${config.extension} | Обработано: ${processedCount} / ${totalImages}`;
                    }
                }
                
                // Активируем кнопку скачивания после обработки сборки (если есть хотя бы одно обработанное изображение)
                if (processedImages.length > 0) {
                    downloadBtn.disabled = false;
                }
            }
            
            statusEl.textContent = `Готово! Обработано ${processedCount} изображений из сборок`;
        }

        async function downloadCompilationZip(compilationName) {
            const statusEl = document.getElementById('status');
            
            // Находим все обработанные изображения для этой сборки
            const compilationImages = allProcessedImages.filter(img => img.compilation === compilationName);
            
            if (compilationImages.length === 0) {
                statusEl.textContent = `Нет обработанных изображений для сборки "${compilationName}"`;
                return;
            }
            
            statusEl.textContent = `Создание ZIP архива для ${compilationName}...`;
            
            try {
                const zip = new JSZip();
                const folder = zip.folder(compilationName).folder('thumbnails');
                
                for (const img of compilationImages) {
                    try {
                        if (!img.previewUrl || typeof img.previewUrl !== 'string') {
                            console.warn(`Пропущено изображение ${img.filename}: некорректный previewUrl`);
                            continue;
                        }
                        
                        const base64Index = img.previewUrl.indexOf(',');
                        if (base64Index === -1) {
                            console.warn(`Пропущено изображение ${img.filename}: некорректный формат base64`);
                            continue;
                        }
                        
                        const base64Data = img.previewUrl.substring(base64Index + 1);
                        const binaryData = atob(base64Data);
                        const bytes = new Uint8Array(binaryData.length);
                        for (let i = 0; i < binaryData.length; i++) {
                            bytes[i] = binaryData.charCodeAt(i);
                        }
                        folder.file(img.filename, bytes);
                    } catch (error) {
                        console.error(`Ошибка при добавлении ${img.filename} в ZIP:`, error);
                    }
                }
                
                statusEl.textContent = `Генерация ZIP файла для ${compilationName}...`;
                const blob = await zip.generateAsync({ type: 'blob' });
                
                // Скачивание
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${compilationName}-previews-50percent.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                statusEl.textContent = `ZIP архив для ${compilationName} успешно скачан!`;
            } catch (error) {
                statusEl.textContent = `Ошибка создания ZIP для ${compilationName}: ${error.message}`;
                console.error(error);
            }
        }

        async function processGallery(statusEl, progressBar, processBtn, downloadAllBtn, resultsEl) {
            if (!galleryConfig.images || galleryConfig.images.length === 0) {
                statusEl.textContent = 'Нет изображений в галерее';
                return;
            }
            
            const images = galleryConfig.images.sort((a, b) => a.order - b.order);
            const totalImages = images.length;
            let processedCount = 0;
            
            statusEl.textContent = `Обработка ${totalImages} изображений из галереи...`;
            
            const section = document.createElement('div');
            section.className = 'compilation-section';
            section.innerHTML = `<div class="compilation-title">Галерея</div><div class="preview-grid" id="gallery-grid"></div>`;
            resultsEl.appendChild(section);
            
            const gridEl = document.getElementById('gallery-grid');
            processedImages = [];
            
            for (const image of images) {
                const imagePath = image.src.startsWith('/') ? image.src : '/' + image.src;
                // Извлекаем имя файла из пути (например, из /images/1.jpg получаем 1.jpg)
                const fileName = imagePath.split('/').pop();
                const thumbnailPath = `/images/thumbnails/${fileName}`;
                
                // Проверка существования thumbnail файла
                const thumbnailExists = await checkFileExists(thumbnailPath);
                
                if (thumbnailExists) {
                    // Пропускаем, если thumbnail уже существует
                    const skippedItem = document.createElement('div');
                    skippedItem.className = 'preview-item';
                    skippedItem.style.opacity = '0.6';
                    skippedItem.innerHTML = `
                        <div class="info" style="color: #888;">thumbnails/${fileName}</div>
                        <div class="info" style="color: #888;">Пропущено (уже существует)</div>
                    `;
                    gridEl.appendChild(skippedItem);
                    
                    processedCount++;
                    const progress = (processedCount / totalImages) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    statusEl.textContent = `Пропущено (уже существует): thumbnails/${fileName} | Обработано: ${processedCount} / ${totalImages}`;
                    continue;
                }
                
                try {
                    const processed = await processImage(imagePath, 'gallery', fileName, null, 'gallery');
                    processedImages.push(processed);
                    allProcessedImages.push(processed);
                    
                    // Создание элемента превью
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${processed.previewUrl}" alt="${image.title}">
                        <div class="info">${imagePath}</div>
                        <div class="info">Оригинал: ${(processed.originalSize / 1024).toFixed(2)} KB</div>
                        <div class="info">Превью: ${(processed.previewSize / 1024).toFixed(2)} KB</div>
                        <a href="${processed.previewUrl}" download="${processed.filename}" class="download-link">Скачать</a>
                    `;
                    gridEl.appendChild(previewItem);
                    
                    processedCount++;
                    const progress = (processedCount / totalImages) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    statusEl.textContent = `Обработано: ${processedCount} / ${totalImages}`;
                } catch (error) {
                    console.error(`Ошибка обработки ${imagePath}:`, error);
                    processedCount++;
                    const progress = (processedCount / totalImages) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                }
            }
            
            statusEl.textContent = `Готово! Обработано ${processedCount} изображений из галереи`;
        }

        async function checkFileExists(filePath) {
            // Используем XMLHttpRequest для более тихой проверки
            // Полностью убрать 404 из консоли браузера невозможно, но можно минимизировать
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', filePath, true);
                xhr.timeout = 5000; // Таймаут 5 секунд
                
                xhr.onload = function() {
                    resolve(xhr.status >= 200 && xhr.status < 400);
                };
                
                xhr.onerror = function() {
                    resolve(false);
                };
                
                xhr.ontimeout = function() {
                    resolve(false);
                };
                
                xhr.onabort = function() {
                    resolve(false);
                };
                
                try {
                    xhr.send();
                } catch (error) {
                    resolve(false);
                }
            });
        }

        async function processImage(imagePath, compilation, index, extension, mode) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                // Устанавливаем обработчики до установки src, чтобы избежать гонок
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        // Конвертация в base64 с качеством 50%
                        const quality = 0.5;
                        const mimeType = extension === 'png' ? 'image/png' : 'image/jpeg';
                        
                        // Для PNG качество не работает, поэтому используем JPEG для всех превью
                        const previewDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Получение размера оригинального изображения через fetch
                        fetch(imagePath)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}`);
                                }
                                return response.blob();
                            })
                            .then(blob => {
                                const originalSize = blob.size;
                                const previewSize = Math.round((previewDataUrl.length - previewDataUrl.indexOf(',') - 1) * 0.75); // Примерный размер base64
                                
                                // Для галереи index уже содержит имя файла (например, "1.jpg")
                                // Для сборок index - это число, нужно создать имя файла
                                const filename = mode === 'gallery' ? index : `${index}.jpg`;
                                
                                resolve({
                                    originalPath: imagePath,
                                    previewUrl: previewDataUrl,
                                    filename: filename,
                                    compilation: compilation,
                                    index: index,
                                    originalSize: originalSize,
                                    previewSize: previewSize,
                                    width: img.width,
                                    height: img.height,
                                    mode: mode
                                });
                            })
                            .catch(error => {
                                // Если не удалось получить размер, используем оценку
                                const previewSize = Math.round((previewDataUrl.length - previewDataUrl.indexOf(',') - 1) * 0.75);
                                const filename = mode === 'gallery' ? index : `${index}.jpg`;
                                
                                resolve({
                                    originalPath: imagePath,
                                    previewUrl: previewDataUrl,
                                    filename: filename,
                                    compilation: compilation,
                                    index: index,
                                    originalSize: 0, // Неизвестный размер
                                    previewSize: previewSize,
                                    width: img.width,
                                    height: img.height,
                                    mode: mode
                                });
                            });
                    } catch (error) {
                        reject(new Error(`Ошибка обработки изображения: ${error.message}`));
                    }
                };
                
                img.onerror = (event) => {
                    // Тихая обработка ошибок загрузки
                    reject(new Error(`Не удалось загрузить ${imagePath}`));
                };
                
                // Устанавливаем src в последнюю очередь
                img.src = imagePath;
            });
        }

        document.getElementById('downloadAllBtn').addEventListener('click', async () => {
            const statusEl = document.getElementById('status');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            
            if (allProcessedImages.length === 0) {
                statusEl.textContent = 'Нет обработанных изображений';
                return;
            }
            
            downloadAllBtn.disabled = true;
            statusEl.textContent = 'Создание ZIP архива...';
            
            try {
                const zip = new JSZip();
                
                // Определяем режим из первого изображения
                const mode = allProcessedImages[0]?.mode || 'compilations';
                
                if (mode === 'gallery') {
                    // Для галереи создаем папку thumbnails в корне
                    const thumbnailsFolder = zip.folder('thumbnails');
                    for (const img of allProcessedImages) {
                        try {
                            // Конвертация base64 в blob
                            if (!img.previewUrl || typeof img.previewUrl !== 'string') {
                                console.warn(`Пропущено изображение ${img.filename}: некорректный previewUrl`);
                                continue;
                            }
                            
                            const base64Index = img.previewUrl.indexOf(',');
                            if (base64Index === -1) {
                                console.warn(`Пропущено изображение ${img.filename}: некорректный формат base64`);
                                continue;
                            }
                            
                            const base64Data = img.previewUrl.substring(base64Index + 1);
                            const binaryData = atob(base64Data);
                            const bytes = new Uint8Array(binaryData.length);
                            for (let i = 0; i < binaryData.length; i++) {
                                bytes[i] = binaryData.charCodeAt(i);
                            }
                            thumbnailsFolder.file(img.filename, bytes);
                        } catch (error) {
                            console.error(`Ошибка при добавлении ${img.filename} в ZIP:`, error);
                            // Продолжаем обработку других файлов
                        }
                    }
                } else {
                    // Для сборок группируем по сборкам
                    const byCompilation = {};
                    for (const img of allProcessedImages) {
                        if (!byCompilation[img.compilation]) {
                            byCompilation[img.compilation] = [];
                        }
                        byCompilation[img.compilation].push(img);
                    }
                    
                    // Добавление изображений в ZIP
                    for (const compilation of Object.keys(byCompilation)) {
                        const folder = zip.folder(compilation).folder('thumbnails');
                        for (const img of byCompilation[compilation]) {
                            try {
                                // Конвертация base64 в blob
                                if (!img.previewUrl || typeof img.previewUrl !== 'string') {
                                    console.warn(`Пропущено изображение ${img.filename}: некорректный previewUrl`);
                                    continue;
                                }
                                
                                const base64Index = img.previewUrl.indexOf(',');
                                if (base64Index === -1) {
                                    console.warn(`Пропущено изображение ${img.filename}: некорректный формат base64`);
                                    continue;
                                }
                                
                                const base64Data = img.previewUrl.substring(base64Index + 1);
                                const binaryData = atob(base64Data);
                                const bytes = new Uint8Array(binaryData.length);
                                for (let i = 0; i < binaryData.length; i++) {
                                    bytes[i] = binaryData.charCodeAt(i);
                                }
                                folder.file(img.filename, bytes);
                            } catch (error) {
                                console.error(`Ошибка при добавлении ${img.filename} в ZIP:`, error);
                                // Продолжаем обработку других файлов
                            }
                        }
                    }
                }
                
                statusEl.textContent = 'Генерация ZIP файла...';
                const blob = await zip.generateAsync({ type: 'blob' });
                
                // Скачивание
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const zipName = mode === 'gallery' ? 'gallery-previews-50percent.zip' : 'previews-50percent.zip';
                a.download = zipName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                statusEl.textContent = 'ZIP архив успешно скачан!';
                downloadAllBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `Ошибка создания ZIP: ${error.message}`;
                console.error(error);
                downloadAllBtn.disabled = false;
            }
        });

        // Обработчик для скачивания выбранных сборок
        document.getElementById('downloadSelectedBtn').addEventListener('click', async () => {
            const statusEl = document.getElementById('status');
            const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
            
            if (currentMode !== 'compilations') {
                statusEl.textContent = 'Эта функция доступна только для режима сборок';
                return;
            }
            
            const selectedCompilations = getSelectedCompilations();
            
            if (selectedCompilations.length === 0) {
                statusEl.textContent = 'Выберите хотя бы одну сборку для скачивания';
                return;
            }
            
            // Фильтруем обработанные изображения только для выбранных сборок
            const selectedImages = allProcessedImages.filter(img => 
                selectedCompilations.includes(img.compilation)
            );
            
            if (selectedImages.length === 0) {
                statusEl.textContent = 'Нет обработанных изображений для выбранных сборок. Сначала обработайте их.';
                return;
            }
            
            downloadSelectedBtn.disabled = true;
            statusEl.textContent = `Создание ZIP архива для ${selectedCompilations.length} сборок...`;
            
            try {
                const zip = new JSZip();
                
                // Группируем по сборкам
                const byCompilation = {};
                for (const img of selectedImages) {
                    if (!byCompilation[img.compilation]) {
                        byCompilation[img.compilation] = [];
                    }
                    byCompilation[img.compilation].push(img);
                }
                
                // Добавление изображений в ZIP
                for (const compilation of Object.keys(byCompilation)) {
                    const folder = zip.folder(compilation).folder('thumbnails');
                    for (const img of byCompilation[compilation]) {
                        try {
                            if (!img.previewUrl || typeof img.previewUrl !== 'string') {
                                console.warn(`Пропущено изображение ${img.filename}: некорректный previewUrl`);
                                continue;
                            }
                            
                            const base64Index = img.previewUrl.indexOf(',');
                            if (base64Index === -1) {
                                console.warn(`Пропущено изображение ${img.filename}: некорректный формат base64`);
                                continue;
                            }
                            
                            const base64Data = img.previewUrl.substring(base64Index + 1);
                            const binaryData = atob(base64Data);
                            const bytes = new Uint8Array(binaryData.length);
                            for (let i = 0; i < binaryData.length; i++) {
                                bytes[i] = binaryData.charCodeAt(i);
                            }
                            folder.file(img.filename, bytes);
                        } catch (error) {
                            console.error(`Ошибка при добавлении ${img.filename} в ZIP:`, error);
                        }
                    }
                }
                
                statusEl.textContent = 'Генерация ZIP файла...';
                const blob = await zip.generateAsync({ type: 'blob' });
                
                // Скачивание
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const compilationNames = selectedCompilations.join('-');
                a.download = `selected-compilations-${compilationNames}-previews-50percent.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                statusEl.textContent = `ZIP архив для ${selectedCompilations.length} сборок успешно скачан!`;
                downloadSelectedBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `Ошибка создания ZIP: ${error.message}`;
                console.error(error);
                downloadSelectedBtn.disabled = false;
            }
        });
    </script>
</body>
</html>


